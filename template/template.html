<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>desktopPyLauncher JSON Viewer</title>
<style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",YuGothic,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#1e1e1e;color:#eee;}
    #canvasWrapper{position: relative;width: 100%;height: 100%;overflow: hidden; cursor: grab;background: #2b2b2b;}
    #canvas{position:relative;min-width:2000px;min-height:2000px;}
    .item{position:absolute;box-sizing:border-box;border-radius:4px;overflow:hidden;}
    .launcher img{width:100%;height:100%;object-fit:contain;display:block;}
    .note{padding:6px;overflow:auto;white-space:pre-wrap;}
    .note table{border-collapse:collapse;width:100%;}
    .note table, .note th, .note td{border:1px solid #666;}
    .note th,.note td{padding:4px;}
    .marker{border:none;background:transparent;display:flex;align-items:center;justify-content:center;color:#ff6666;font-size:18px;font-weight:bold;text-shadow:2px 2px 4px rgba(0,0,0,0.8);}
    .marker::before{content:"📍";font-size:24px;margin-right:4px;}
    .caption{position:absolute;text-align:center;color:#ccc;font-size:12px;pointer-events:none;text-shadow:1px 1px 1px rgba(0,0,0,.75);}
    .marker-caption{color:#ffcccc;font-weight:bold;text-shadow:1px 1px 2px rgba(0,0,0,0.8);}
    .videoPlaceholder{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#000;color:#888;font-size:14px;font-family:monospace;}
    #minimapCanvas{position:fixed;right:16px;bottom:16px;width:180px;height:180px;background:rgba(0,0,0,0.6);border:1px solid #aaa;z-index:1000;}
    .item a{color:#aaf;}
    .item a:hover{color:#eea;}

    #canvasWrapper{
      scroll:both;
      overflow:scroll;
    }
</style>
</head>
<body>
<div id="canvasWrapper"><div id="canvas"></div></div>
<canvas id="minimapCanvas" width="180" height="180"></canvas>

<script type="application/json" id="jsonData"><!-- embeded_json_data//--></script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const definedIcons = {
  ".bat":"res/batch-file.png", ".cmd":"res/batch-file.png", ".py":"res/python-file.png",
  ".exe":"res/exe-file.png", ".url":"res/url-file.png", ".lnk":"res/shortcut-file.png",
  ".txt":"res/text-file.png", ".md":"res/markdown-file.png", ".json":"res/json-file.png"
};

const wrapper = document.getElementById("canvasWrapper");
// スクロールバーを消してホイールイベントを確実にキャッチ
wrapper.style.overflow = "hidden";

const canvas = document.getElementById("canvas");
// 拡大縮小の原点を左上に固定
canvas.style.transformOrigin = "0 0";

const mini = document.getElementById("minimapCanvas");
const mCtx = mini.getContext("2d");

// グローバル状態
let zoom        = 1.0;
let translateX  = 0;
let translateY  = 0;
const MIN_ZOOM  = 0.2;
const MAX_ZOOM  = 5.0;
let isDragging  = false;
let dragStartX  = 0;
let dragStartY  = 0;
let miniScale   = 1;
const markers   = new Map();

/** ドラッグ開始 */
function onDragStart(e) {
  if (e.button !== 0) return;
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  wrapper.style.cursor = "grabbing";
  e.preventDefault();
}

/** ドラッグ中 */
function onDragMove(e) {
  if (!isDragging) return;
  const dx = e.clientX - dragStartX;
  const dy = e.clientY - dragStartY;
  translateX += dx;
  translateY += dy;
  canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  drawMini();
}

/** ドラッグ終了 */
function onDragEnd(e) {
  if (!isDragging) return;
  isDragging = false;
  wrapper.style.cursor = "grab";
  drawMini();
}

/** ホイールでズーム（中心をラッパー基準で計算） */
function onWheel(e) {
  e.preventDefault();
  const wR = wrapper.getBoundingClientRect();
  const dx = e.clientX - wR.left;
  const dy = e.clientY - wR.top;
  const x  = (dx - translateX) / zoom;
  const y  = (dy - translateY) / zoom;
  const factor  = e.deltaY < 0 ? 1.1 : 0.9;
  const newZoom = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, zoom * factor));
  translateX = dx - x * newZoom;
  translateY = dy - y * newZoom;
  zoom = newZoom;
  canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
  drawMini();
}

/** UI構築 */
function buildUI(data) {
  if (!data || !Array.isArray(data.items)) return;
  canvas.innerHTML = "";
  let maxX = 0, maxY = 0;
  data.items.forEach(it => {
    maxX = Math.max(maxX, it.x + (it.width || 48));
    maxY = Math.max(maxY, it.y + (it.height|| 48));
  });
  canvas.style.minWidth  = (maxX + 400) + "px";
  canvas.style.minHeight = (maxY + 400) + "px";
  miniScale = Math.min(mini.width/(maxX+400), mini.height/(maxY+400));
  data.items.forEach(it => {
    switch(it.type) {
      case "launcher":
      case "json":   addLauncher(it); break;
      case "image":  addImage(it);    break;
      case "note":   addNote(it);     break;
      case "video":  addVideo(it);    break;
      case "marker": addMarker(it);   break;
      default: console.warn("unsupported type", it.type);
    }
  });
  drawMini();
}

/** ミニマップ再描画 */
function drawMini(){
  mCtx.clearRect(0,0,mini.width,mini.height);
  mCtx.fillStyle="#444"; mCtx.fillRect(0,0,mini.width,mini.height);
  const rect = canvas.getBoundingClientRect();
  canvas.querySelectorAll(".item").forEach(el=>{
    const r = el.getBoundingClientRect();
    const x = (r.left - rect.left)*miniScale;
    const y = (r.top  - rect.top )*miniScale;
    const w = r.width   *miniScale;
    const h = r.height  *miniScale;
    mCtx.fillStyle = el.classList.contains("marker")
      ? "rgba(255,100,100,0.8)"
      : "rgba(0,200,255,0.5)";
    mCtx.fillRect(x,y,Math.max(2,w),Math.max(2,h));
  });
  // ビューポート矩形（translate/zoom を逆算）
  const vx = (-translateX/zoom)*miniScale;
  const vy = (-translateY/zoom)*miniScale;
  const vw = (wrapper.clientWidth / zoom)*miniScale;
  const vh = (wrapper.clientHeight/ zoom)*miniScale;
  mCtx.strokeStyle="#ff0"; mCtx.lineWidth=1;
  mCtx.strokeRect(vx,vy,vw,vh);
}

/* -------------------------------- */


/**
 * キャプション追加
 */
function addCaption(d, text, isMarker = false) {
  if (!text) return;
  const cap = document.createElement("div");
  cap.className = isMarker ? "caption marker-caption" : "caption";
  cap.textContent = text;
  cap.style.left  = d.x + "px";
  cap.style.top   = (d.y + d.height + 2) + "px";
  cap.style.width = d.width + "px";
  canvas.appendChild(cap);
}

/**
 * ダブルクリックでURLを開く
 */
function attachOpenUrl(el, url) {
  if (!url || !(url.startsWith("http://") || url.startsWith("https://"))) return;
  el.style.cursor = "pointer";
  el.addEventListener("dblclick", e => {
    window.open(url, "_blank");
    e.stopPropagation();
  });
}

/**
 * 明るさフィルター適用
 */
function applyBrightness(element, brightness) {
  if (brightness == null || brightness === 50) return;
  const filterValue = brightness / 50;
  element.style.filter = `brightness(${filterValue})`;
}

/**
 * LauncherItem 描画
 */
function addLauncher(d) {
  const el = document.createElement("div");
  el.className = "item launcher";
  Object.assign(el.style, {
    left:   d.x + "px",
    top:    d.y + "px",
    width:  d.width  + "px",
    height: d.height + "px"
  });

  let imgSrc = "";
  if (d.icon_embed)       imgSrc = "data:image/png;base64," + d.icon_embed;
  else if (d.embed)       imgSrc = "data:image/png;base64," + d.embed;
  else {
    const ext = d.path ? d.path.substring(d.path.lastIndexOf(".")).toLowerCase() : "";
    imgSrc = definedIcons[ext] || "res/default.png";
  }

  const img = new Image();
  img.src = imgSrc;
  img.onload  = () => { applyBrightness(img, d.brightness); drawMini(); };
  img.onerror = () => {
    img.src = "data:image/svg+xml;base64," +
      btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="48" height="48" fill="#666"/><text x="24" y="28" fill="#ccc" font-size="12" text-anchor="middle">?</text></svg>');
    applyBrightness(img, d.brightness);
    drawMini();
  };

  el.appendChild(img);
  canvas.appendChild(el);
  addCaption(d, d.caption);
  attachOpenUrl(el, d.path);
}

/**
 * ImageItem 描画
 */
function addImage(d) {
  const box = document.createElement("div");
  box.className = "item";
  Object.assign(box.style, {
    left:   d.x + "px",
    top:    d.y + "px",
    width:  d.width  + "px",
    height: d.height + "px"
  });

  const img = new Image();
  img.style.width     = "100%";
  img.style.height    = "100%";
  img.style.objectFit = "contain";

  if ((d.store === "embed" || !d.path) && (d.embed || d.data)) {
    img.src = "data:image/*;base64," + (d.embed || d.data);
  } else {
    img.src = d.path;
  }

  img.onload  = () => { applyBrightness(img, d.brightness); drawMini(); };
  img.onerror = () => {
    img.src = "data:image/svg+xml;base64," +
      btoa('<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="#333"/><text x="50" y="50" fill="#ccc" font-size="12" text-anchor="middle">画像読み込み失敗</text></svg>');
    applyBrightness(img, d.brightness);
    drawMini();
  };

  box.appendChild(img);
  canvas.appendChild(box);
  addCaption(d, d.caption);
  attachOpenUrl(box, d.path);
}

/**
 * VideoItem プレースホルダ
 */
function addVideo(d) {
  const box = document.createElement("div");
  box.className = "item";
  Object.assign(box.style, {
    left:   d.x + "px",
    top:    d.y + "px",
    width:  d.width  + "px",
    height: d.height + "px"
  });
  const ph = document.createElement("div");
  ph.className   = "videoPlaceholder";
  ph.textContent = "📹 Video (Not Supported)";
  box.appendChild(ph);
  canvas.appendChild(box);
  addCaption(d, d.caption || "Video");
}

/**
 * MarkerItem ジャンプ
 */
function jumpToMarker(id) {
  const target = markers.get(id);
  if (target) {
    target.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

/**
 * MarkerItem 描画
 */
function addMarker(d) {
  const el = document.createElement("div");
  el.className = "item marker" + (d.jump_id != null ? " clickable" : "");
  Object.assign(el.style, {
    left:   d.x + "px",
    top:    d.y + "px",
    width:  d.width  + "px",
    height: d.height + "px"
  });

  let markerText = "";
  if (d.is_start) {
    markerText = "START";
    el.style.color = "#66ff66";
  } else if (d.jump_id) {
    markerText = `→${d.jump_id}`;
    el.style.color = "#ffff66";
  } else {
    markerText = `ID:${d.id}`;
    el.style.color = "#ff6666";
  }

  el.title       = `Marker ID: ${d.id}` +
                   (d.jump_id ? `, Jump to: ${d.jump_id}` : "") +
                   (d.is_start ? " (START)" : "");
  el.textContent = markerText;
  canvas.appendChild(el);

  markers.set(d.id, el);
  if (d.jump_id != null) {
    el.addEventListener("dblclick", e => {
      jumpToMarker(d.jump_id);
      e.stopPropagation();
    });
  }
  if (d.show_caption !== false) {
    addCaption(d, d.caption, true);
  }
}

/**
 * NoteItem 描画／編集切替
 */
function addNote(d) {
  const el = document.createElement("div");
  el.className = "item note" + (d.fill_background ? " has-background" : "");
  Object.assign(el.style, {
    left:       d.x + "px",
    top:        d.y + "px",
    width:      d.width  + "px",
    height:     d.height + "px",
    userSelect: "none"
  });
  el.style.background = d.fill_background ? (d.bgcolor || "#222") : "transparent";
  if (d.color)    el.style.color    = d.color;
  if (d.fontsize) el.style.fontSize = d.fontsize + "px";

  const content = d.text || "";
  el.innerHTML   = d.format === "markdown" ? marked.parse(content) : content;

  el.addEventListener("dblclick", e => {
    e.preventDefault();
    if (!el.isContentEditable) {
      el.contentEditable = "true";
      el.style.userSelect = "text";
      el.focus();
      let range;
      if (document.caretRangeFromPoint) {
        range = document.caretRangeFromPoint(e.clientX, e.clientY);
      } else if (document.caretPositionFromPoint) {
        const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
        range = document.createRange();
        range.setStart(pos.offsetNode, pos.offset);
      }
      if (range) {
        range.collapse(true);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    } else {
      el.contentEditable = "false";
      el.style.userSelect = "none";
    }
    e.stopPropagation();
  });

  el.addEventListener("mousedown", e => {
    if (el.isContentEditable) e.stopPropagation();
  });

  canvas.appendChild(el);
}

document.addEventListener("DOMContentLoaded", () => {
  wrapper.addEventListener("mousedown",  onDragStart);
  wrapper.addEventListener("mousemove",  onDragMove);
  wrapper.addEventListener("mouseup",    onDragEnd);
  wrapper.addEventListener("mouseleave", onDragEnd);
  wrapper.addEventListener("wheel",      onWheel);

  try {
    const jsonElement = document.getElementById("jsonData");
    if (jsonElement && jsonElement.textContent.trim()) {
      const data = JSON.parse(jsonElement.textContent);
      buildUI(data);
    }
  } catch (err) {
    console.error("JSON解析エラー:", err);
  }

  window.addEventListener("load", drawMini);
});
</script>



</body>
</html>
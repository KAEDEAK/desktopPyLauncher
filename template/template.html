<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title><!-- title --></title>
<!-- Google Fonts: Noto Sans JP -->
<!--
  ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ version 1.1 ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚
  é•·ã„ãƒãƒ¼ãƒˆã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚line-heightãªã©ãŒç•°ãªã‚‹ãŸã‚ã§ã™ã€‚
  ä¸€å¿œè¡¨ç¤ºã¯ã§ãã¾ã™ãŒã€æ ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’å›²ã‚“ã ã‚Šã€çŸ¢å°ã§å˜èªç­‰ã‚’ç¤ºã—ã¦ã‚‚ãšã‚Œã¾ã™ã€‚
  ãšã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€çŸ­ã„ãƒãƒ¼ãƒˆã‚’ä½œã£ã¦ã€ãã®ãƒãƒ¼ãƒˆè‡ªä½“ã‚’æ ã§å›²ã£ãŸã‚Šã—ã¦ãã ã•ã„ã€‚
//-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š - Noto Sans JPã§çµ±ä¸€ */
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    /* Noto Sans JPã‚’æœ€å„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚æŒ‡å®š */
    font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3', sans-serif;
    background: #1e1e1e;
    color: #eee;
    /* ãƒ•ã‚©ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’çµ±ä¸€ */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

#canvasWrapper {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    cursor: grab;
    background: #2b2b2b;
}

#canvas {
    position: relative;
    min-width: 2000px;
    min-height: 2000px;
    /* æ‹¡å¤§ç¸®å°ã®åŸç‚¹ã‚’å·¦ä¸Šã«å›ºå®š */
    transform-origin: 0 0;
}

.item {
    position: absolute;
    box-sizing: border-box;
    border-radius: 4px;
    overflow: hidden;
}

.launcher img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
}

/* ãƒãƒ¼ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ”¹å–„ï¼ˆãƒ•ã‚©ãƒ³ãƒˆçµ±ä¸€ç‰ˆ + ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼å¯¾ç­–ï¼‰ */
.note {
    padding: 0;
    margin: 0;
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼å¯¾ç­–ï¼šoverflowã‚’hiddenã«å¤‰æ›´ã—ã€ç¸¦ä½™è£•ã‚’5pxè¿½åŠ  */
    overflow: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
    /* æ˜ç¤ºçš„ã«Noto Sans JPã‚’æŒ‡å®š */
    font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif;
    line-height: 1.3; /* Noto Sans JPç”¨ã«å¾®èª¿æ•´ */
    /* Webkitãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ */
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
    /* ãƒ•ã‚©ãƒ³ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®çµ±ä¸€ */
    font-feature-settings: "palt" 1; /* ãƒ—ãƒ­ãƒãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
}

/* ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒªã‚»ãƒƒãƒˆ */
.note-content {
    margin: 0;
    padding: 4px; /* 5pxâ†’4pxã«å¾®èª¿æ•´ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼å¯¾ç­– */
    box-sizing: border-box;
    /* è¡Œã®é«˜ã•ã‚’å³å¯†ã«æŒ‡å®š */
    line-height: 1.3;
    /* å†…éƒ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚µã‚¤ã‚ºè¨ˆç®—ã‚’èª¿æ•´ */
    height: calc(100% - 2px); /* è¦ªã®é«˜ã•ã‹ã‚‰å¾®èª¿æ•´ */
    overflow-y: auto; /* å¿…è¦æ™‚ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    overflow-x: hidden;
}

/* Markdownè¦ç´ ã®å³å¯†ãªãƒªã‚»ãƒƒãƒˆï¼ˆChromeå¯¾å¿œï¼‰ */
.note-content * {
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³/ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ */
    margin: 0;
    padding: 0;
    /* è¦ªè¦ç´ ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¨è‰²ã‚’ç¶™æ‰¿ */
    font-size: inherit;
    color: inherit;
    line-height: 1.3;
    /* ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚‚ç¶™æ‰¿ */
    font-family: inherit;
    /* Webkitã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã */
    -webkit-margin-before: 0;
    -webkit-margin-after: 0;
    -webkit-margin-start: 0;
    -webkit-margin-end: 0;
    -webkit-padding-before: 0;
    -webkit-padding-after: 0;
    -webkit-padding-start: 0;
    -webkit-padding-end: 0;
}

/* Markdown ã®è¦‹å‡ºã—ï¼ˆPythonç‰ˆã«åˆã‚ã›ã¦èª¿æ•´ï¼‰ */
.note-content h1 { 
    font-size: 1.8em; 
    margin: 0.5em 0 0.3em 0; 
    font-weight: 700; 
    line-height: 1.2;
    border-bottom: 1px solid #666;
    padding-bottom: 0.2em;
}
.note-content h2 { 
    font-size: 1.4em; 
    margin: 0.4em 0 0.25em 0; 
    font-weight: 700; 
    line-height: 1.2;
    border-bottom: 1px solid #555;
    padding-bottom: 0.15em;
}
.note-content h3 { 
    font-size: 1.2em; 
    margin: 0.35em 0 0.2em 0; 
    font-weight: 700; 
    line-height: 1.2; 
}
.note-content h4 { 
    font-size: 1.1em; 
    margin: 0.3em 0 0.15em 0; 
    font-weight: 700; 
    line-height: 1.2; 
}
.note-content h5 { 
    font-size: 1em; 
    margin: 0.25em 0 0.1em 0; 
    font-weight: 700; 
    line-height: 1.2; 
}
.note-content h6 { 
    font-size: 0.9em; 
    margin: 0.2em 0 0.1em 0; 
    font-weight: 700; 
    line-height: 1.2; 
}

/* Markdown ã®æ®µè½ï¼ˆPythonç‰ˆã®ã‚ˆã†ã«é©åº¦ãªé–“éš”ã ãŒã€ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.note-content p { 
    margin: 0.6em 0;
    line-height: 1.4;
}
.note-content p:first-child { margin-top: 0; }
.note-content p:last-child { margin-bottom: 0; }

/* ãƒªã‚¹ãƒˆã®èª¿æ•´ï¼ˆPythonç‰ˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã ãŒã€ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.note-content ul, .note-content ol { 
    margin: 0.6em 0; 
    padding-left: 1.5em;
    /* Chromeã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã */
    -webkit-padding-start: 1.5em;
    list-style-position: outside;
}
.note-content ul { list-style-type: disc; }
.note-content ol { list-style-type: decimal; }

.note-content li { 
    margin: 0.15em 0;
    line-height: 1.4;
    /* Chromeã®ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³ã‚’é™¤å» */
    display: list-item;
}
.note-content ul:first-child, .note-content ol:first-child { margin-top: 0; }
.note-content ul:last-child, .note-content ol:last-child { margin-bottom: 0; }

/* ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆã®èª¿æ•´ */
.note-content li > ul, .note-content li > ol {
    margin-top: 0.15em;
    margin-bottom: 0.15em;
}
.note-content li > ul { list-style-type: circle; }
.note-content li > ul > li > ul { list-style-type: square; }

/* Markdown ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆPythonç‰ˆé¢¨ã ãŒã€ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.note-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 0.6em 0;
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒœãƒƒã‚¯ã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’çµ±ä¸€ */
    box-sizing: border-box;
    line-height: 1.3;
}
.note-content table:first-child { margin-top: 0; }
.note-content table:last-child { margin-bottom: 0; }
.note-content table, .note-content th, .note-content td {
    border: 1px solid #666;
}
.note-content th {
    padding: 4px 8px;
    background: rgba(255,255,255,0.1);
    font-weight: 700;
    text-align: left;
}
.note-content td {
    padding: 4px 8px;
}
.note-content tr:nth-child(even) {
    background: rgba(255,255,255,0.02);
}

/* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¨ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆPythonç‰ˆé¢¨ã ãŒã€ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.note-content code {
    background: rgba(0,0,0,0.4);
    padding: 0.1em 0.3em;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.85em;
    /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¡Œé«˜ã‚’èª¿æ•´ */
    line-height: 1;
    color: #f8f8f2;
}
.note-content pre {
    background: rgba(0,0,0,0.4);
    padding: 0.6em;
    border-radius: 5px;
    overflow-x: auto;
    margin: 0.6em 0;
    /* preã‚¿ã‚°å†…ã®ç©ºç™½ã‚’ä¿æŒ */
    white-space: pre;
    line-height: 1.3;
    border: 1px solid #555;
}
.note-content pre:first-child { margin-top: 0; }
.note-content pre:last-child { margin-bottom: 0; }
.note-content pre code {
    background: none;
    padding: 0;
    font-size: inherit;
    border-radius: 0;
}

/* æ°´å¹³ç·šï¼ˆPythonç‰ˆé¢¨ï¼‰ */
.note-content hr {
    border: none;
    border-top: 2px solid #666;
    margin: 1.2em 0;
    /* Chromeã®hrãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã */
    height: 0;
    box-sizing: content-box;
}

/* ãƒªãƒ³ã‚¯ï¼ˆPythonç‰ˆé¢¨ï¼‰ */
.note-content a {
    color: #69b7ff;
    text-decoration: none;
    border-bottom: 1px solid #69b7ff;
}
.note-content a:hover {
    color: #ffcc66;
    border-bottom-color: #ffcc66;
}

/* å¼•ç”¨ï¼ˆPythonç‰ˆé¢¨ã ãŒã€ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.note-content blockquote {
    border-left: 4px solid #666;
    margin: 0.6em 0;
    padding-left: 0.8em;
    color: #ccc;
    font-style: italic;
}
.note-content blockquote:first-child { margin-top: 0; }
.note-content blockquote:last-child { margin-bottom: 0; }

/* å¼·èª¿ãƒ»æ–œä½“ */
.note-content strong, .note-content b { 
    font-weight: 700; 
    color: #fff;
}
.note-content em, .note-content i { 
    font-style: italic; 
}

/* ç”»åƒ */
.note-content img {
    max-width: 100%;
    height: auto;
    vertical-align: middle;
    border-radius: 4px;
    margin: 0.3em 0;
}

/* ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.launcher { border: 2px solid #6b6b6b; background-color: #333; }
.image { border: 2px solid #4a8f4a; background-color: #333; }
.note { background-color: #323334; border: 2px solid #5b5b5b; color: #CCCACD; }
.marker { border: 2px solid #d4842e; background-color: #444; color: #CCCACD; }
.video { border: 2px solid #ff6b6b; background-color: #333; }

/* ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ */
.caption {
    position: absolute;
    font-size: 12px;
    color: #ccc;
    text-align: center;
    background: rgba(0,0,0,0.8);
    padding: 2px 4px;
    border-radius: 3px;
    white-space: nowrap;
    max-width: 200px;
}
.marker-caption {
    color: #d4842e;
}

/* ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
.videoPlaceholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background: #444;
    color: #ccc;
    font-size: 14px;
    text-align: center;
}

/* ãƒŸãƒ‹ãƒãƒƒãƒ— */
#minimapCanvas {
    position: absolute;
    top: 10px;
    right: 10px;
    border: 2px solid #666;
    background: rgba(0,0,0,0.8);
    cursor: pointer;
}
</style>
</head>

<body>

<div id="canvasWrapper">
  <div id="canvas"></div>
</div>

<canvas id="minimapCanvas" width="180" height="180"></canvas>

<script type="application/json" id="jsonData"><!-- embedded_json_data//--></script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
const definedIcons = {
  ".bat":"res/batch-file.png", ".cmd":"res/batch-file.png", ".py":"res/python-file.png",
  ".exe":"res/exe-file.png", ".url":"res/url-file.png", ".lnk":"res/shortcut-file.png",
  ".txt":"res/text-file.png", ".md":"res/markdown-file.png", ".json":"res/json-file.png"
};

// DOMè¦ç´ ã®å‚ç…§
const wrapper = document.getElementById("canvasWrapper");
const canvas = document.getElementById("canvas");
const mini = document.getElementById("minimapCanvas");
const mCtx = mini.getContext("2d");

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’æ¶ˆã—ã¦ãƒ›ã‚¤ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«ã‚­ãƒ£ãƒƒãƒ
wrapper.style.overflow = "hidden";

// ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
let zoom = 1.0;
let translateX = 0;
let translateY = 0;
const MIN_ZOOM = 0.2;
const MAX_ZOOM = 5.0;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let miniScale = 1;
const markers = new Map();

// Zå€¤ã®ç®¡ç†ç”¨
let zMin = 0;
let zMax = 0;
let zRange = 1;

/**
 * Zå€¤ã‚’é©ç”¨ï¼ˆ0-1000ã®ç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
 */
function applyZIndex(element, zValue) {
  if (typeof zValue === 'number') {
    // Zå€¤ã‚’0-1000ã®ç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°
    const normalizedZ = zRange > 0 ? ((zValue - zMin) / zRange) * 1000 : 500;
    element.style.zIndex = Math.round(normalizedZ);
  } else {
    element.style.zIndex = 500; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  }
}

/**
 * ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
 */
function addCaption(d, text, isMarker = false) {
  if (!text) return;
  const cap = document.createElement("div");
  cap.className = isMarker ? "caption marker-caption" : "caption";
  cap.textContent = text;
  cap.style.left = d.x + "px";
  cap.style.top = (d.y + d.height + 2) + "px";
  cap.style.width = d.width + "px";
  
  // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®Zå€¤ã¯è¦ªã‚¢ã‚¤ãƒ†ãƒ ã‚ˆã‚Šå°‘ã—é«˜ãè¨­å®š
  if (typeof d.z === 'number') {
    const normalizedZ = zRange > 0 ? ((d.z - zMin) / zRange) * 1000 : 500;
    cap.style.zIndex = Math.round(normalizedZ) + 1;
  } else {
    cap.style.zIndex = 501; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ + 1
  }
  
  canvas.appendChild(cap);
}

/**
 * ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§URLã‚’é–‹ã
 */
function attachOpenUrl(el, url) {
  if (!url || !url.trim()) return;
  el.addEventListener("dblclick", () => window.open(url, "_blank"));
}

/**
 * æ˜åº¦èª¿æ•´ã‚’é©ç”¨
 */
function applyBrightness(imgEl, brightness) {
  brightness = brightness || 100;
  if (brightness !== 100) {
    imgEl.style.filter = `brightness(${brightness}%)`;
  }
}

/**
 * ãƒŸãƒ‹ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½
 */
function onMinimapClick(e) {
  const rect = mini.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;
  
  // ãƒŸãƒ‹ãƒãƒƒãƒ—åº§æ¨™ã‚’ã‚·ãƒ¼ãƒ³åº§æ¨™ã«å¤‰æ›
  const sceneX = clickX / miniScale;
  const sceneY = clickY / miniScale;
  
  // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®ä¸­å¿ƒãŒã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«ãªã‚‹ã‚ˆã†ã«ç§»å‹•
  const centerX = wrapper.clientWidth / 2;
  const centerY = wrapper.clientHeight / 2;
  
  translateX = centerX - sceneX * zoom;
  translateY = centerY - sceneY * zoom;
  
  canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
  drawMini();
}

/**
 * ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
 */
function onDragStart(e) {
  if (e.button !== 0) return;
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  wrapper.style.cursor = "grabbing";
  e.preventDefault();
}

/**
 * ãƒ‰ãƒ©ãƒƒã‚°ä¸­
 */
function onDragMove(e) {
  if (!isDragging) return;
  const dx = e.clientX - dragStartX;
  const dy = e.clientY - dragStartY;
  translateX += dx;
  translateY += dy;
  canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  drawMini();
}

/**
 * ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
 */
function onDragEnd(e) {
  if (!isDragging) return;
  isDragging = false;
  wrapper.style.cursor = "grab";
  drawMini();
}

/**
 * ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆä¸­å¿ƒã‚’ãƒ©ãƒƒãƒ‘ãƒ¼åŸºæº–ã§è¨ˆç®—ï¼‰
 */
function onWheel(e) {
  e.preventDefault();
  const wR = wrapper.getBoundingClientRect();
  const dx = e.clientX - wR.left;
  const dy = e.clientY - wR.top;
  const x = (dx - translateX) / zoom;
  const y = (dy - translateY) / zoom;
  const factor = e.deltaY < 0 ? 1.1 : 0.9;
  const newZoom = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, zoom * factor));
  translateX = dx - x * newZoom;
  translateY = dy - y * newZoom;
  zoom = newZoom;
  canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoom})`;
  drawMini();
}

/**
 * UIæ§‹ç¯‰
 */
function buildUI(data) {
  if (!data || !Array.isArray(data.items)) return;
  canvas.innerHTML = "";
  
  // Zå€¤ã®ç¯„å›²ã‚’è¨ˆç®—
  const zValues = data.items.map(it => it.z || 0).filter(z => typeof z === 'number');
  if (zValues.length > 0) {
    zMin = Math.min(...zValues);
    zMax = Math.max(...zValues);
    zRange = zMax - zMin;
    if (zRange === 0) zRange = 1; // 0é™¤ç®—ã‚’é¿ã‘ã‚‹
  } else {
    zMin = 0;
    zMax = 0;
    zRange = 1;
  }
  
  let maxX = 0, maxY = 0;
  data.items.forEach(it => {
    maxX = Math.max(maxX, it.x + (it.width || 48));
    maxY = Math.max(maxY, it.y + (it.height|| 48));
  });
  canvas.style.minWidth = (maxX + 400) + "px";
  canvas.style.minHeight = (maxY + 400) + "px";
  miniScale = Math.min(mini.width/(maxX+400), mini.height/(maxY+400));
  
  data.items.forEach(it => {
    switch(it.type) {
      case "launcher":
      case "json":   addLauncher(it); break;
      case "image":
      case "gif":    addImage(it);    break;
      case "note":   addNote(it);     break;
      case "video":  addVideo(it);    break;
      case "marker": addMarker(it);   break;
      case "rect":   addRect(it);     break;
      case "arrow":  addArrow(it);    break;
      default: console.warn("unsupported type", it.type);
    }
  });
  drawMini();
}

/**
 * ãƒŸãƒ‹ãƒãƒƒãƒ—å†æç”»
 */
function drawMini() {
  mCtx.clearRect(0, 0, mini.width, mini.height);
  mCtx.fillStyle = "#444"; 
  mCtx.fillRect(0, 0, mini.width, mini.height);
  
  const rect = canvas.getBoundingClientRect();
  canvas.querySelectorAll(".item").forEach(el => {
    const r = el.getBoundingClientRect();
    const x = (r.left - rect.left) * miniScale;
    const y = (r.top - rect.top) * miniScale;
    const w = r.width * miniScale;
    const h = r.height * miniScale;
    mCtx.fillStyle = el.classList.contains("marker")
      ? "rgba(255,100,100,0.8)"
      : "rgba(0,200,255,0.5)";
    mCtx.fillRect(x, y, Math.max(2, w), Math.max(2, h));
  });
  
  // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆçŸ©å½¢ï¼ˆtranslate/zoom ã‚’é€†ç®—ï¼‰
  const vx = (-translateX / zoom) * miniScale;
  const vy = (-translateY / zoom) * miniScale;
  const vw = (wrapper.clientWidth / zoom) * miniScale;
  const vh = (wrapper.clientHeight / zoom) * miniScale;
  mCtx.strokeStyle = "#ff0"; 
  mCtx.lineWidth = 1;
  mCtx.strokeRect(vx, vy, vw, vh);
}

/**
 * MarkerItem ã‚¸ãƒ£ãƒ³ãƒ—
 */
function jumpToMarker(id) {
  const target = markers.get(id);
  if (target) {
    target.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

/**
 * LauncherItem æç”»ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œç‰ˆï¼‰
 */
function addLauncher(d) {
  const el = document.createElement("div");
  el.className = "item launcher";
  Object.assign(el.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: d.height + "px"
  });

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(el, d.z);

  let imgSrc;
  
  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
  if (d.image_embedded && d.image_embedded_data) {
    // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: image_embedded_data + image_format
    const format = d.image_format || "data:image/png;base64,";
    imgSrc = format + d.image_embedded_data;
  } else if (d.icon_embed || d.embed || d.data) {
    // å¤ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    const iconData = d.icon_embed || d.embed || d.data;
    let mimeType = "image/*";
    
    // base64ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®æ–‡å­—ã§ç”»åƒå½¢å¼ã‚’åˆ¤å®š
    if (iconData.startsWith("/9j/")) {
      mimeType = "image/jpeg";
    } else if (iconData.startsWith("iVBOR")) {
      mimeType = "image/png";
    } else if (iconData.startsWith("R0lGOD")) {
      mimeType = "image/gif";
    }
    
    imgSrc = `data:${mimeType};base64,${iconData}`;
  } else if (d.path) {
    // ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ã‚³ãƒ³
    const ext = d.path.substring(d.path.lastIndexOf(".")).toLowerCase();
    imgSrc = definedIcons[ext] || "res/default.png";
  } else {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
    imgSrc = "res/default.png";
  }

  const img = new Image();
  img.src = imgSrc;
  img.onload = () => { 
    applyBrightness(img, d.brightness); 
    drawMini(); 
  };
  img.onerror = () => {
    console.warn("Launcher icon load error for:", d);
    img.src = "data:image/svg+xml;base64," +
      btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="48" height="48" fill="#666"/><text x="24" y="28" fill="#ccc" font-size="12" text-anchor="middle">?</text></svg>');
    applyBrightness(img, d.brightness);
    drawMini();
  };

  el.appendChild(img);
  canvas.appendChild(el);
  addCaption(d, d.caption);
  attachOpenUrl(el, d.path);
}

/**
 * ImageItem æç”»ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œç‰ˆï¼‰
 */
function addImage(d) {
  const box = document.createElement("div");
  box.className = "item image";
  Object.assign(box.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: d.height + "px"
  });

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(box, d.z);

  const img = new Image();
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";

  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
  if (d.image_embedded && d.image_embedded_data) {
    // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: image_embedded_data + image_format
    const format = d.image_format || "data:image/*;base64,";
    img.src = format + d.image_embedded_data;
  } else if ((d.store === "embed" || !d.path) && (d.embed || d.data)) {
    // å¤ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    let mimeType = "image/*";
    const base64Data = d.embed || d.data;
    
    // typeã«åŸºã¥ã„ã¦MIMEã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
    if (d.type === "gif") {
      mimeType = "image/gif";
    } else if (d.type === "image") {
      // base64ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®æ–‡å­—ã§ç”»åƒå½¢å¼ã‚’åˆ¤å®š
      if (base64Data.startsWith("/9j/")) {
        mimeType = "image/jpeg";
      } else if (base64Data.startsWith("iVBOR")) {
        mimeType = "image/png";
      } else if (base64Data.startsWith("R0lGOD")) {
        mimeType = "image/gif";
      } else {
        mimeType = "image/jpeg"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      }
    }
    
    img.src = `data:${mimeType};base64,${base64Data}`;
  } else if (d.path) {
    // ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®ç”»åƒ
    img.src = d.path;
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚¨ãƒ©ãƒ¼ç”»åƒã‚’è¡¨ç¤º
    img.src = "data:image/svg+xml;base64," +
      btoa('<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="#333"/><text x="50" y="50" fill="#ccc" font-size="12" text-anchor="middle">ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—</text></svg>');
  }

  img.onload = () => { 
    applyBrightness(img, d.brightness); 
    drawMini(); 
  };
  img.onerror = () => {
    console.warn("Image load error for:", d);
    img.src = "data:image/svg+xml;base64," +
      btoa('<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="#333"/><text x="50" y="50" fill="#ccc" font-size="12" text-anchor="middle">ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—</text></svg>');
    applyBrightness(img, d.brightness);
    drawMini();
  };

  box.appendChild(img);
  canvas.appendChild(box);
  addCaption(d, d.caption);
  attachOpenUrl(box, d.path);
}

/**
 * VideoItem ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
 */
function addVideo(d) {
  const box = document.createElement("div");
  box.className = "item video";
  Object.assign(box.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: d.height + "px"
  });

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(box, d.z);

  const ph = document.createElement("div");
  ph.className = "videoPlaceholder";
  ph.textContent = "ğŸ“¹ Video (Not Supported)";
  box.appendChild(ph);
  canvas.appendChild(box);
  addCaption(d, d.caption || "Video");
}

/**
 * MarkerItem æç”»
 */
function addMarker(d) {
  const el = document.createElement("div");
  el.className = "item marker" + (d.jump_id != null ? " jump-marker" : "");
  Object.assign(el.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: d.height + "px",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    fontSize: Math.min(16, d.height * 0.4) + "px",
    fontWeight: "bold"
  });

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(el, d.z);

  const text = d.text || "ğŸ”¹";
  el.textContent = text;

  if (d.jump_id != null) {
    markers.set(d.jump_id, el);
    el.style.cursor = "pointer";
    el.addEventListener("click", () => jumpToMarker(d.jump_id));
  }

  canvas.appendChild(el);
  addCaption(d, d.caption, true);
  attachOpenUrl(el, d.path);
}

/**
 * NoteItem æç”»ï¼ˆæ”¹å–„ç‰ˆï¼‰
 */
function addNote(d) {
  const el = document.createElement("div");
  el.className = "item note";
  
  // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼å¯¾ç­–ï¼šé«˜ã•ã‚’5pxä½™è£•ã‚’æŒãŸã›ã‚‹
  const adjustedHeight = (d.height || 100) + 5;
  
  Object.assign(el.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: adjustedHeight + "px"
  });

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(el, d.z);

  // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã®é©ç”¨ï¼ˆèƒŒæ™¯è‰²ã€ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€ãƒ†ã‚­ã‚¹ãƒˆè‰²ï¼‰
  if (d.bgcolor) {
    el.style.backgroundColor = d.bgcolor;
  }
  if (d.color) {
    el.style.color = d.color;
  }
  if (d.fontsize) {
    el.style.fontSize = d.fontsize + "px";
  }

  const contentDiv = document.createElement("div");
  contentDiv.className = "note-content";

  // èƒŒæ™¯ã®å¡—ã‚Šã¤ã¶ã—è¨­å®š
  if (d.fill_background === false || d.fill_bg === false) {
    el.style.background = "transparent";
    el.style.border = "none";
  }

  // Markdownã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã®å‡¦ç†
  if (d.format === "markdown") {
    try {
      contentDiv.innerHTML = marked.parse(d.text || "");
    } catch (err) {
      console.warn("Markdown parsing error:", err);
      contentDiv.textContent = d.text || "";
    }
  } else {
    contentDiv.textContent = d.text || "";
  }

  el.appendChild(contentDiv);

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
  el.addEventListener("dblclick", e => {
    if (contentDiv.isContentEditable) {
      contentDiv.contentEditable = "false";
      contentDiv.style.userSelect = "none";
      el.style.userSelect = "none";
    } else {
      contentDiv.contentEditable = "true";
      contentDiv.style.userSelect = "auto";
      el.style.userSelect = "auto";
      contentDiv.focus();
      if (d.format === "text") {
        const range = document.createRange();
        range.selectNodeContents(contentDiv);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    e.stopPropagation();
  });

  // ç·¨é›†ä¸­ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
  el.addEventListener("mousedown", e => {
    const contentDiv = el.querySelector('.note-content');
    if (contentDiv && contentDiv.isContentEditable) {
      e.stopPropagation();
    }
  });

  canvas.appendChild(el);
}

/**
 * RectItem æç”»ï¼ˆçŸ©å½¢ï¼‰
 */
function addRect(d) {
  const el = document.createElement("div");
  el.className = "item rect";
  Object.assign(el.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: d.height + "px",
    borderRadius: (d.corner_radius || 0) + "px",
    position: "absolute"
  });

  if (typeof d.angle === "number" && d.angle % 360 !== 0) {
    el.style.transform = `rotate(${d.angle}deg)`;
    el.style.transformOrigin = `${d.width/2}px ${d.height/2}px`;
  }

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(el, d.z);

  // æ ç·šã®è¨­å®š
  const frameColor = d.frame_color || "#FF0000";
  const frameWidth = d.frame_width || 2;
  el.style.border = `${frameWidth}px solid ${frameColor}`;

  // èƒŒæ™¯ã®è¨­å®š
  if (d.background_transparent === false) {
    el.style.backgroundColor = d.background_color || "#FFFFFF";
  } else {
    el.style.backgroundColor = "transparent";
  }

  canvas.appendChild(el);
  addCaption(d, d.caption);
  attachOpenUrl(el, d.path);
}

/**
 * ä¸ãˆã‚‰ã‚ŒãŸè§’åº¦ã§çŸ¢å°ãŒå¤–æ¥æ¥•å††ã«åã¾ã‚‹é•·ã•ã‚’æ±‚ã‚ã‚‹
 */
function calculateArrowLength(w, h, angle) {
  if (w <= 0 || h <= 0) return Math.min(w, h) * 0.8;
  const a = w / 2;
  const b = h / 2;
  const rad = angle * Math.PI / 180;
  const cosT = Math.cos(rad);
  const sinT = Math.sin(rad);
  const denom = (cosT / a) ** 2 + (sinT / b) ** 2;
  if (denom > 0) {
    return (1 / Math.sqrt(denom)) * 2;
  }
  return Math.min(w, h) * 0.8;
}

/**
 * ArrowItem æç”»ï¼ˆçŸ¢å°ï¼‰
 */
function addArrow(d) {
  const el = document.createElement("div");
  el.className = "item arrow";
  Object.assign(el.style, {
    left: d.x + "px",
    top: d.y + "px",
    width: d.width + "px",
    height: d.height + "px",
    position: "absolute"
  });

  // Zå€¤ã‚’é©ç”¨
  applyZIndex(el, d.z);

  // SVGã§çŸ¢å°ã‚’æç”»
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", d.width);
  svg.setAttribute("height", d.height);
  svg.style.width = "100%";
  svg.style.height = "100%";

  const angle = d.angle || 0;
  const frameColor = d.frame_color || "#FF0000";
  const frameWidth = d.frame_width || 2;
  const bgColor = d.background_color || "#FFFFFF";
  const bgTransparent = d.background_transparent !== false;
  
  const centerX = d.width / 2;
  const centerY = d.height / 2;
  const arrowLength = calculateArrowLength(d.width, d.height, angle) * (d.is_line ? 0.9 : 0.85);

  if (d.is_line) {
    // ç›´ç·šçŸ¢å°ï¼ˆâ†’ï¼‰
    const arrowHeadSize = arrowLength * 0.3;
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    
    // çŸ¢å°ã®ãƒ‘ã‚¹ã‚’å®šç¾©
    const pathData = `
      M ${centerX - arrowLength/2} ${centerY}
      L ${centerX + arrowLength/2} ${centerY}
      M ${centerX + arrowLength/2} ${centerY}
      L ${centerX + arrowLength/2 - arrowHeadSize * 0.3} ${centerY - arrowHeadSize * 0.2}
      M ${centerX + arrowLength/2} ${centerY}
      L ${centerX + arrowLength/2 - arrowHeadSize * 0.3} ${centerY + arrowHeadSize * 0.2}
    `;
    
    path.setAttribute("d", pathData);
    path.setAttribute("stroke", frameColor);
    path.setAttribute("stroke-width", frameWidth);
    path.setAttribute("fill", "none");
    path.setAttribute("transform", `rotate(${angle} ${centerX} ${centerY})`);
    
    svg.appendChild(path);
  } else {
    // ãƒãƒªã‚´ãƒ³çŸ¢å°ï¼ˆâ‡’ï¼‰
    const arrowWidth = arrowLength * 0.4;
    const arrowHeadLength = arrowLength * 0.3;
    
    const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    
    // çŸ¢å°ã®é ‚ç‚¹ã‚’å®šç¾©ï¼ˆæ¨ªå‘ãï¼‰
    const points = [
      [centerX - arrowLength/2, centerY - arrowWidth/4],
      [centerX + arrowLength/2 - arrowHeadLength, centerY - arrowWidth/4],
      [centerX + arrowLength/2 - arrowHeadLength, centerY - arrowWidth/2],
      [centerX + arrowLength/2, centerY],
      [centerX + arrowLength/2 - arrowHeadLength, centerY + arrowWidth/2],
      [centerX + arrowLength/2 - arrowHeadLength, centerY + arrowWidth/4],
      [centerX - arrowLength/2, centerY + arrowWidth/4]
    ];
    
    const pointsStr = points.map(p => p.join(",")).join(" ");
    polygon.setAttribute("points", pointsStr);
    polygon.setAttribute("stroke", frameColor);
    polygon.setAttribute("stroke-width", frameWidth);
    polygon.setAttribute("fill", bgTransparent ? "none" : bgColor);
    polygon.setAttribute("transform", `rotate(${angle} ${centerX} ${centerY})`);
    
    svg.appendChild(polygon);
  }

  el.appendChild(svg);
  canvas.appendChild(el);
  addCaption(d, d.caption);
  attachOpenUrl(el, d.path);
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
document.addEventListener("DOMContentLoaded", () => {
  wrapper.addEventListener("mousedown", onDragStart);
  wrapper.addEventListener("mousemove", onDragMove);
  wrapper.addEventListener("mouseup", onDragEnd);
  wrapper.addEventListener("mouseleave", onDragEnd);
  wrapper.addEventListener("wheel", onWheel);

  // ãƒŸãƒ‹ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
  mini.addEventListener("click", onMinimapClick);

  try {
    const jsonElement = document.getElementById("jsonData");
    if (jsonElement && jsonElement.textContent.trim()) {
      const data = JSON.parse(jsonElement.textContent);
      buildUI(data);
    }
  } catch (err) {
    console.error("JSONè§£æã‚¨ãƒ©ãƒ¼:", err);
  }

  window.addEventListener("load", drawMini);
});
</script>

</body>
</html>
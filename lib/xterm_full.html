<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XTerm Terminal</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #ffffff;
            overflow: hidden;
        }
        #terminal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 10px;
            box-sizing: border-box;
        }
        
        /* xterm.js theme customization */
        .xterm {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.2;
        }
        
        .xterm-viewport {
            background-color: #000000;
        }
        
        .xterm-selection {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .xterm-cursor {
            background-color: #ffffff;
            color: #000000;
        }
    </style>
    <!-- xterm.js Local Files -->
    <link rel="stylesheet" href="xterm.css" />
    <script src="xterm.js"></script>
    <script src="xterm-addon-fit.js"></script>
</head>
<body>
    <div id="terminal"></div>
    
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
        console.log("XTerm Terminal starting...");
        
        // Global variables
        let term;
        let fitAddon;
        let backend = null;
        let currentInput = '';
        let isWebChannelReady = false;
        
        // Claude CLI問題調査のためデバッグモードを自動有効化
        window.claudeDebugMode = true;
        
        // Initialize terminal
        function initTerminal() {
            console.log("Initializing xterm.js terminal...");
            
            // Create terminal instance
            if (typeof Terminal === 'undefined') {
                console.error('Terminal is not defined. xterm.js may not be loaded properly.');
                return;
            }
            term = new Terminal({
                cursorBlink: true,
                convertEol: false,  // Claude CLIのカーソル制御を阻害しないように無効化
                fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                fontSize: 14,
                lineHeight: 1.2,
                cols: 120,  // Claude CLI用に広めに設定
                rows: 50,   // Claude CLIが使用する44行目以上をカバー
                scrollback: 1000,
                allowTransparency: true,
                macOptionIsMeta: true,
                disableStdin: false,  // 入力を有効化
                cursorStyle: 'block', // カーソルスタイルを明示的に設定
                // Claude CLI対応のため、より厳密なエスケープシーケンス処理
                fastScrollModifier: 'alt',
                fastScrollSensitivity: 5,
                scrollSensitivity: 1,
                altClickMovesCursor: false,
                rightClickSelectsWord: false,
                // 重要：エスケープシーケンス処理の設定
                windowsMode: true,  // Windows特有の処理を有効化
                theme: {
                    background: '#000000',
                    foreground: '#ffffff',
                    cursor: '#ffffff',
                    cursorAccent: '#000000',
                    selection: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#cd3131',
                    green: '#0dbc79',
                    yellow: '#e5e510',
                    blue: '#2472c8',
                    magenta: '#bc3fbc',
                    cyan: '#11a8cd',
                    white: '#e5e5e5',
                    brightBlack: '#666666',
                    brightRed: '#f14c4c',
                    brightGreen: '#23d18b',
                    brightYellow: '#f5f543',
                    brightBlue: '#3b8eea',
                    brightMagenta: '#d670d6',
                    brightCyan: '#29b8db',
                    brightWhite: '#ffffff'
                }
            });
            
            // Create fit addon
            if (typeof FitAddon === 'undefined') {
                console.error('FitAddon is not defined. xterm-addon-fit.js may not be loaded properly.');
                return;
            }
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            
            // Open terminal
            term.open(document.getElementById('terminal'));
            
            // Fit to container
            fitAddon.fit();
            
            // Handle terminal data (user input)
            term.onData(data => {
                console.log("Terminal data:", data);
                if (backend && isWebChannelReady) {
                    backend.write_to_shell(data);
                }
            });
            
            // Handle special keys
            term.attachCustomKeyEventHandler((event) => {
                if (event.type === 'keydown') {
                    // Let xterm.js handle scrolling internally
                    if (event.key === 'PageUp') {
                        // Scroll up in xterm.js buffer
                        term.scrollPages(-1);
                        return false; // Prevent default
                    } else if (event.key === 'PageDown') {
                        // Scroll down in xterm.js buffer
                        term.scrollPages(1);
                        return false; // Prevent default
                    }
                }
                return true; // Let xterm.js handle other keys
            });
            
            // Handle resize
            term.onResize(({ cols, rows }) => {
                console.log(`Terminal resized to ${cols}x${rows}`);
                if (backend && isWebChannelReady) {
                    // Convert cols/rows to pixel dimensions
                    const charWidth = 8.0;  // xterm.js character width
                    const charHeight = 16.8;  // xterm.js line height
                    const width = cols * charWidth;
                    const height = rows * charHeight;
                    backend.set_terminal_size(width, height);
                }
            });
            
            // Focus terminal
            term.focus();
            
            console.log("XTerm terminal initialized successfully");
            
            // Initial messages - commented out to avoid being cleared by resize
            // term.write("\x1b[32mXTerm Terminal Ready\x1b[0m\r\n");
            // term.write("\x1b[33mStarting shell...\x1b[0m\r\n");
            
            // Don't start shell here - it will be started by the Python side
            // if (backend && isWebChannelReady) {
            //     backend.start_shell("cmd", "");
            // }
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (fitAddon) {
                fitAddon.fit();
            }
        });
        
        // WebChannel setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, setting up WebChannel...");
            
            new QWebChannel(qt.webChannelTransport, function(channel) {
                console.log("WebChannel connected successfully");
                backend = channel.objects.backend;
                isWebChannelReady = true;
                
                console.log("Backend object:", backend);
                
                // Connect to backend signals
                backend.output_ready.connect(function(data) {
                    if (window.claudeDebugMode) {
                        console.log("Raw data from backend:", JSON.stringify(data));
                        const sequences = analyzeEscapeSequences(data);
                        if (sequences.length > 0) {
                            console.log("Escape sequences found:", sequences);
                        }
                    }
                    if (term) {
                        // Claude CLI特有の問題に対処
                        // カーソル位置制御の直前に改行が来ている場合の処理
                        let processedData = data;
                        
                        // パターン: \r\n の直後にカーソル位置制御が来る場合
                        // これがスクロールを引き起こしている可能性
                        if (processedData.includes('\r\n\x1b[')) {
                            console.log("FOUND PROBLEMATIC PATTERN: \\r\\n followed by escape sequence");
                            // \r\n\x1b[29;1H\x1b[K のような場合、\r\nを削除してみる
                            processedData = processedData.replace(/\r\n(\x1b\[[0-9]+;[0-9]+H)/g, '$1');
                        }
                        
                        term.write(processedData);
                    }
                });
                
                // Initialize terminal after backend is ready
                initTerminal();
            });
        });
        
        // Expose functions for Python to call
        window.resizeTerminal = function() {
            console.log("Terminal resize requested");
            if (fitAddon) {
                fitAddon.fit();
            }
        };
        
        window.updateTerminalDimensions = function() {
            console.log("Terminal dimensions update requested");
            if (fitAddon) {
                fitAddon.fit();
            }
        };
        
        window.changeShell = function(shellType, workingDir) {
            console.log("Changing shell to:", shellType, workingDir);
            if (backend && isWebChannelReady) {
                backend.start_shell(shellType, workingDir);
            }
        };
        
        window.clearTerminal = function() {
            console.log("Clearing terminal");
            if (term) {
                term.clear();
            }
        };
        
        // Claude CLI問題対策用のデバッグ機能
        window.debugClaudeIssues = function(enable) {
            if (enable) {
                console.log("Claude CLI debug mode enabled - showing escape sequences");
                window.claudeDebugMode = true;
            } else {
                console.log("Claude CLI debug mode disabled");
                window.claudeDebugMode = false;
            }
        };
        
        // エスケープシーケンス解析用ヘルパー
        window.analyzeEscapeSequences = function(data) {
            const sequences = [];
            const escapePattern = /\x1b\[[0-9;]*[a-zA-Z]/g;
            let match;
            while ((match = escapePattern.exec(data)) !== null) {
                sequences.push({
                    sequence: match[0],
                    position: match.index,
                    description: getEscapeDescription(match[0])
                });
            }
            return sequences;
        };
        
        function getEscapeDescription(seq) {
            if (seq.match(/\x1b\[[0-9]+;[0-9]+H/)) return "Cursor Position";
            if (seq.match(/\x1b\[2J/)) return "Clear Screen";
            if (seq.match(/\x1b\[K/)) return "Clear Line";
            if (seq.match(/\x1b\[[ABCD]/)) return "Cursor Move";
            if (seq.match(/\x1b\[H/)) return "Cursor Home";
            return "Other";
        }
        
        window.syncTerminal = function() {
            console.log("Synchronizing terminal for Claude CLI compatibility");
            if (fitAddon && term) {
                term.clear();
                fitAddon.fit();
            }
        };
        
        console.log("XTerm Terminal script loaded with Claude CLI compatibility");
    </script>
</body>
</html>